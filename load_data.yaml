name: Load PESTLE Datasets
description: Fetches PESTLE datasets using correct domains for each service
inputs:
  - {name: access_token, type: string, description: "Bearer access token from IAM login"}
  - {name: iam_domain, type: string, description: "Domain for IAM service"}
  - {name: api_domain, type: string, description: "Domain for data API"}
  - {name: schema_ids, type: String, description: "JSON string with schema IDs mapping"}
  - {name: page_size, type: Integer, default: "10000", description: "Number of records per page"}
outputs:
  - {name: worldbank_data, type: Dataset}
  - {name: imf_data, type: Dataset}
  - {name: oecd_data, type: Dataset}
  - {name: comtrade_data, type: Dataset}
  - {name: patents_data, type: Dataset}
  - {name: country_industry_data, type: Dataset}
  - {name: pestle_scores_data, type: Dataset}
  - {name: agriculture_forestry_data, type: Dataset}
  - {name: schema_metadata, type: String}
implementation:
  container:
    image: python:3.9-slim
    command:
      - sh
      - -ec
      - |
        apt-get update > /dev/null && apt-get install -y curl ca-certificates > /dev/null
        pip3 install --quiet requests pandas || pip3 install --quiet requests pandas --user
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import os
        import json
        import pickle
        import requests
        import pandas as pd
        import urllib3
        import warnings
        from datetime import datetime
        
        warnings.filterwarnings('ignore')
        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
        
        parser = argparse.ArgumentParser(description="Load PESTLE Datasets")
        parser.add_argument('--access_token', type=str, required=True)
        parser.add_argument('--iam_domain', type=str, required=True)
        parser.add_argument('--api_domain', type=str, required=True)
        parser.add_argument('--schema_ids', type=str, required=True)
        parser.add_argument('--page_size', type=int, default=10000)
        
        parser.add_argument('--worldbank_data', type=str, required=True)
        parser.add_argument('--imf_data', type=str, required=True)
        parser.add_argument('--oecd_data', type=str, required=True)
        parser.add_argument('--comtrade_data', type=str, required=True)
        parser.add_argument('--patents_data', type=str, required=True)
        parser.add_argument('--country_industry_data', type=str, required=True)
        parser.add_argument('--pestle_scores_data', type=str, required=True)
        parser.add_argument('--agriculture_forestry_data', type=str, required=True)
        parser.add_argument('--schema_metadata', type=str, required=True)
        
        args = parser.parse_args()

        with open(args.access_token, 'r') as f:
            access_token = f.read().strip()

        print("LOADING PESTLE DATASETS")
        print("Using domains:")
        print("IAM Domain: " + args.iam_domain)
        print("API Domain: " + args.api_domain)

        try:
            schema_mapping = json.loads(args.schema_ids)
        except:
            schema_mapping = {
                "worldbank": "68c16c9033b961627a6b7cea",
                "imf": "68c484885fafa83bbffefd22",
                "oecd": "68c46c315fafa83bbffefd20",
                "comtrade": "68e66005d0b6dd4b1f848547",
                "patents": "68e79ed7d0b6dd4b1f84854c",
                "country_industry": "68b055294e7cc90774f5db7d",
                "pestle_scores": "69269d55f1dcf736e80891d8",
                "agriculture_forestry": "68b54a72449b0c059a42adbc"
            }

        headers = {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + access_token
        }

        payload = {
            "dbType": "TIDB",
            "entityId": "",
            "entityIds": [],
            "ownedOnly": False,
            "projections": [],
            "filter": {},
            "startTime": 0,
            "endTime": 0
        }

        def fetch_schema_data(schema_name, schema_id):
            print("Fetching " + schema_name + "...")
            print("Schema ID: " + schema_id)
            
            url = args.api_domain + "/pi-entity-instances-service/v2.0/schemas/" + schema_id + "/instances/list?page=0&size=" + str(args.page_size) + "&showDBaaSReservedKeywords=true"
            print("URL: " + url)
            
            try:
                response = requests.post(
                    url, 
                    headers=headers, 
                    json=payload, 
                    timeout=120,
                    verify=False
                )
                
                print("Status: " + str(response.status_code))
                
                if response.status_code == 200:
                    data = response.json()
                    
                    if isinstance(data, list):
                        print("Success: " + str(len(data)) + " records")
                        
                        df = pd.DataFrame(data)
                        
                        analysis = {
                            "schema_name": schema_name,
                            "schema_id": schema_id,
                            "status": "success",
                            "records": len(data),
                            "columns": list(df.columns),
                            "shape": df.shape,
                            "sample": df.head(3).to_dict(orient='records'),
                            "timestamp": datetime.now().isoformat()
                        }
                        
                        return {
                            "data": data,
                            "df": df,
                            "analysis": analysis
                        }
                    else:
                        print("Unexpected data format: " + str(type(data)))
                        return {
                            "data": data,
                            "df": None,
                            "analysis": {
                                "schema_name": schema_name,
                                "schema_id": schema_id,
                                "status": "unexpected_format",
                                "data_type": str(type(data)),
                                "timestamp": datetime.now().isoformat()
                            }
                        }
                        
                else:
                    print("Failed: " + str(response.status_code))
                    print("Error: " + response.text[:200])
                    
                    return {
                        "data": None,
                        "df": None,
                        "analysis": {
                            "schema_name": schema_name,
                            "schema_id": schema_id,
                            "status": "failed",
                            "status_code": response.status_code,
                            "error": response.text[:500],
                            "timestamp": datetime.now().isoformat()
                        }
                    }
                    
            except Exception as e:
                print("Exception: " + str(e))
                return {
                    "data": None,
                    "df": None,
                    "analysis": {
                        "schema_name": schema_name,
                        "schema_id": schema_id,
                        "status": "exception",
                        "error": str(e),
                        "timestamp": datetime.now().isoformat()
                    }
                }

        all_results = {}
        metadata = {
            "fetch_timestamp": datetime.now().isoformat(),
            "iam_domain": args.iam_domain,
            "api_domain": args.api_domain,
            "page_size": args.page_size,
            "schemas": {}
        }

        for schema_name, schema_id in schema_mapping.items():
            result = fetch_schema_data(schema_name, schema_id)
            all_results[schema_name] = result
            metadata["schemas"][schema_name] = result["analysis"]
            
            output_var_name = schema_name + "_data"
            output_path = getattr(args, output_var_name)
            
            if result["data"] is not None:
                os.makedirs(os.path.dirname(output_path) or ".", exist_ok=True)
                with open(output_path, 'wb') as f:
                    pickle.dump(result["data"], f)
                print("Saved to: " + output_path)
            else:
                os.makedirs(os.path.dirname(output_path) or ".", exist_ok=True)
                with open(output_path, 'wb') as f:
                    pickle.dump([], f)
                print("Created empty file: " + output_path)

        os.makedirs(os.path.dirname(args.schema_metadata) or ".", exist_ok=True)
        with open(args.schema_metadata, 'w') as f:
            json.dump(metadata, f, indent=2)

        print("All datasets processed")
        print("Metadata saved to: " + args.schema_metadata)

        successful = [name for name, result in all_results.items() 
                     if result["analysis"]["status"] == "success"]
        
        print("FETCH SUMMARY:")
        print("Successful: " + str(len(successful)) + "/" + str(len(schema_mapping)))
        print("Failed: " + str(len(schema_mapping) - len(successful)))
        
        for name in successful:
            records = all_results[name]["analysis"]["records"]
            print(name + ": " + str(records) + " records")
            
    args:
      - --access_token
      - {inputPath: access_token}
      - --iam_domain
      - {inputValue: iam_domain}
      - --api_domain
      - {inputValue: api_domain}
      - --schema_ids
      - {inputValue: schema_ids}
      - --page_size
      - {inputValue: page_size}
      - --worldbank_data
      - {outputPath: worldbank_data}
      - --imf_data
      - {outputPath: imf_data}
      - --oecd_data
      - {outputPath: oecd_data}
      - --comtrade_data
      - {outputPath: comtrade_data}
      - --patents_data
      - {outputPath: patents_data}
      - --country_industry_data
      - {outputPath: country_industry_data}
      - --pestle_scores_data
      - {outputPath: pestle_scores_data}
      - --agriculture_forestry_data
      - {outputPath: agriculture_forestry_data}
      - --schema_metadata
      - {outputPath: schema_metadata}
